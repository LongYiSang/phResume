name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-main
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  SHA: ${{ github.sha }}
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/opt/phresume' }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Lowercase owner for GHCR
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY%%/*}"
          echo "OWNER_LC=${owner,,}" >> "${GITHUB_ENV}"

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push api
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile.api.prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/phresume-api:${{ env.SHA }}
            ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/phresume-api:latest

      - name: Build & push worker
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile.worker.prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/phresume-worker:${{ env.SHA }}
            ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/phresume-worker:latest

      - name: Build & push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/phresume-frontend:${{ env.SHA }}
            ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/phresume-frontend:latest

  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    steps:
      - uses: actions/checkout@v4

      - name: Lowercase owner for GHCR
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY%%/*}"
          echo "OWNER_LC=${owner,,}" >> "${GITHUB_ENV}"

      - name: Prepare SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
        run: |
          set -euo pipefail
          test -n "${SSH_PRIVATE_KEY}"
          test -n "${SSH_HOST}"
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts

      - name: Upload compose & nginx config
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        run: |
          set -euo pipefail
          test -n "${SSH_USER}"
          SSH_OPTS=(-i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -p "${SSH_PORT}")
          SCP_OPTS=(-i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -P "${SSH_PORT}")
          ssh "${SSH_OPTS[@]}" "${SSH_USER}@${SSH_HOST}" "mkdir -p '${DEPLOY_PATH}/deploy/nginx'"
          scp "${SCP_OPTS[@]}" docker-compose.prod.yml "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/docker-compose.prod.yml"
          scp "${SCP_OPTS[@]}" deploy/nginx/nginx.prod.conf "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/deploy/nginx/nginx.prod.conf"

      - name: Remote deploy
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        run: |
          set -euo pipefail
          test -n "${SSH_USER}"
          SSH_OPTS=(-i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -p "${SSH_PORT}")
          ssh "${SSH_OPTS[@]}" "${SSH_USER}@${SSH_HOST}" "set -euo pipefail; cd '${DEPLOY_PATH}'; export GHCR_OWNER='${OWNER_LC}'; export APP_VERSION='${SHA}'; docker compose -f docker-compose.prod.yml pull; docker compose -f docker-compose.prod.yml up -d --remove-orphans"
