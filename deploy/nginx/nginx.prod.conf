worker_processes auto;
pid /tmp/nginx.pid;

events {
	worker_connections 1024;
}

http {
	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	server_tokens off;

	sendfile on;
	keepalive_timeout 65;

	access_log /dev/stdout;
	error_log /dev/stderr warn;

	# 限流（按 IP）：降低自动化扫描/爆破与资源耗尽风险
	limit_req_zone $binary_remote_addr zone=auth_zone:10m rate=30r/m;
	limit_req_zone $binary_remote_addr zone=upload_zone:10m rate=10r/m;
	limit_req_zone $binary_remote_addr zone=api_zone:10m rate=10r/s;

	# 将 WebSocket Upgrade 状态映射为合适的 Connection 头
	map $http_upgrade $connection_upgrade {
		default upgrade;
		'' close;
	}

	upstream frontend {
		server frontend:3000;
	}

	upstream api {
		server api:8080;
	}

	server {
		listen 8080;
		listen [::]:8080;

		# TODO(域名就绪后)：建议改为 443 + Let's Encrypt，并设置 HSTS。
		# server_name resume.example.com;

		# 允许 Nginx 缓冲较大的请求体 (例如：文件上传)
		client_max_body_size 10m;

		# 配合只读根文件系统：将临时文件写入 /tmp（tmpfs）
		client_body_temp_path /tmp/client_body_temp;
		proxy_temp_path /tmp/proxy_temp;

		gzip on;
		gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

		# 基础安全头（CSP 需要结合前端资源加载策略单独评估，避免误伤）
		add_header X-Content-Type-Options "nosniff" always;
		add_header Referrer-Policy "no-referrer" always;
		add_header X-Frame-Options "DENY" always;
		add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

		# 生产安全：阻止外网访问内部打印数据接口（仅供 worker 使用）。
		location ~ ^/api/v1/(resume/print|templates/print)/ {
			return 404;
		}

		# 生产安全：不要公开暴露 Prometheus 指标（可通过内网/隧道访问）。
		location = /api/metrics {
			return 404;
		}

		# 仅拦截扫描流量，不影响后续 ACME 接入（.well-known）
		location ~* ^/(?!\\.well-known)(?:\\.(?:env|git|svn|hg)|\\.DS_Store) {
			return 404;
		}
		location ~* ^/(?:cgi-bin/|wp-admin/|wp-includes/|wp-content/|vendor/|phpmyadmin/|pma/|\\.php$) {
			return 404;
		}

		# 对关键接口单独限流（需要在 /api/ 通配前声明）
		location = /api/v1/auth/login {
			limit_req zone=auth_zone burst=20 nodelay;
			proxy_pass http://api;
			rewrite ^/api(/.*)$ $1 break;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_read_timeout 60s;
			proxy_send_timeout 60s;
			proxy_buffering off;
			proxy_connect_timeout 15s;
		}

		location = /api/v1/auth/register {
			limit_req zone=auth_zone burst=20 nodelay;
			proxy_pass http://api;
			rewrite ^/api(/.*)$ $1 break;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_read_timeout 60s;
			proxy_send_timeout 60s;
			proxy_buffering off;
			proxy_connect_timeout 15s;
		}

		location = /api/v1/assets/upload {
			limit_req zone=upload_zone burst=10 nodelay;
			proxy_pass http://api;
			rewrite ^/api(/.*)$ $1 break;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_read_timeout 300s;
			proxy_send_timeout 300s;
			proxy_buffering off;
			proxy_connect_timeout 30s;
		}

		location /api/ {
			limit_req zone=api_zone burst=60 nodelay;
			proxy_pass http://api;
			rewrite ^/api(/.*)$ $1 break;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;

			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_read_timeout 3600s;
			proxy_send_timeout 3600s;
			proxy_buffering off;
			proxy_connect_timeout 60s;
		}

		location / {
			proxy_pass http://frontend;
			proxy_http_version 1.1;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
		}
	}
}
