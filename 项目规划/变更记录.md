# 变更记录
## 鉴权与安全加固（低危/中危项完成）25-12-11 06:20
- 刷新令牌旋转与 CSRF 保护：
  - 旧刷新令牌黑名单吊销，防重复使用：`backend/internal/api/auth_handler.go:208-236, 318-336`。
  - 刷新接口 `SameSite=Lax`、仅 HTTPS 设 `Secure`，Cookie 域从配置注入：`backend/internal/api/auth_handler.go:281-290, 311-323`，配置：`backend/internal/config/config.go:167-210, 303-331`。
  - `.env.example` 增加生产 Cookie 域示例：`backend/.env.example:60-66`。
- WebSocket 收紧：
  - 仅受信源升级；鉴权阶段强制 `TokenType == access`：`backend/internal/api/ws_handler.go:22-57, 114-155`。
- 文件与资产：
  - 资产 key 统一校验，禁止 `..` 与控制字符，扩展白名单：`backend/internal/api/asset_key_validation.go:1-29`、`backend/internal/api/asset_handler.go:198-226`。
  - 上传 MIME 白名单与体积上限：`backend/internal/api/asset_handler.go:68-141`。
- 打印链路：
  - 共享密钥校验抽象为路由中间件，减少重复逻辑：`backend/internal/api/middleware/internal_secret.go:1-26`、`backend/internal/api/routes.go:75-76`。

【构建验证】
- 后端编译通过：`cd backend && go build ./cmd/...` 成功。

【注意事项】
- 生产启用跨子域刷新需设置 `API_COOKIE_DOMAIN=.example.com`；本地留空即可。
- 后续计划将共享 `INTERNAL_API_SECRET` 替换为任务级一次性令牌，进一步降低泄露风险。

## 保持 WebSocket 长时间在线或在断线后自动恢复25-12-11 05:55
- 变更文件与内容
  - `deploy/nginx/nginx.conf`
    - 在 `/api/` 路由添加长超时和关闭缓冲，避免代理因空闲断开：
      - `proxy_read_timeout 3600s;`
      - `proxy_send_timeout 3600s;`
      - `proxy_buffering off;`
      - `proxy_connect_timeout 60s;`
    - 现有升级头保持不变，兼容 REST 与 WebSocket。
  - `backend/internal/api/ws_handler.go`
    - 在订阅循环中增加服务器端 Ping 心跳：
      - 每 30 秒 `WriteControl(PingMessage)`，若失败则关闭连接并退出循环。
    - 心跳有助于维持链路活跃，同时在网络异常时更快发现断开。
  - `frontend/app/page.tsx`
    - 增加轻量心跳与断线自动重连：
      - 在 `onopen` 开启 `setInterval` 每 25 秒发送 `{type:"ping"}`。
      - 在 `onclose`/`onerror` 启用指数退避重连（最大 30 秒），自动恢复连接。
    - 弹窗拦截规避：
      - 在用户点击“生成 PDF”后先打开一个空白新标签引用；当获取到预签名链接时把该标签的 `location.href` 设置为下载地址，否则回退为 `window.open(url)`.
  - `frontend/lib/api-routes.ts`
    - 保持 WebSocket URL 解析逻辑，未改变接口，仅在内部整理。

  - 消除重复逻辑与一致性
    - 统一 WebSocket 消息消费依据后端实际结构：`{status:'completed', resume_id:number}`。前端不再依赖未使用的 `WsEvent` 类型中 `event/url` 结构（frontend/types/api.ts:86-99 仅为声明，不在本次修改范围）。后续建议清理不一致类型。

【执行方案】

- 已实现代码修改，如上各文件变更所述：
  - Nginx 增加 WebSocket 长超时与无缓冲（deploy/nginx/nginx.conf）。
  - 后端 `WsHandler` 增加服务器心跳 Ping（backend/internal/api/ws_handler.go:182-217）。
  - 前端主页面增加心跳与自动重连、空白页预开以规避拦截（frontend/app/page.tsx:204 及 WS 连接与下载逻辑片段）。
- 验证
  - 后端构建通过：`go build ./cmd/api && go build ./cmd/worker` 成功（后端编译无错误）。
  - 前端本地 `next lint` 未运行成功是因为该终端未安装依赖；这不影响逻辑正确性，但建议在你的环境 `cd frontend && npm install && npm run lint` 再跑一次。
- 部署与运行注意
  - 需要重新加载 Nginx 配置以生效：
    - 在 Compose 环境下：`docker-compose restart nginx` 或 `docker-compose up -d --build nginx`.
    - 或容器内执行 `nginx -s reload`。
  - 后端无需特殊重启即可应用心跳逻辑（重新构建/重启 API 服务后生效）。
  - 前端修改在开发模式下热更新；生产需重新构建部署。

【效果与测试建议】

- 长时间停留后点击“生成 PDF”：
  - WebSocket 即使被中途断开也会自动重连；Worker 推送完成消息到 Redis 后，由 API 转发至前端，前端收到后触发下载。
  - 浏览器不会拦截，因为空白标签是在用户点击时同步创建；下载链接到达后替换该标签地址。
- 可视化确认点
  - 浏览器控制台：
    - 连接日志：`WebSocket connected and authenticated.`；断开后出现 `WebSocket disconnected.` 并在数秒内看到重连成功日志。
    - 心跳不会刷屏，仅每 25 秒发送一次。
  - Worker 与 API 日志：
    - API WebSocket handler 会周期性输出 `forwarding message` 和 `write ping` 成功日志。
  - 如果仍出现偶发不跳转：
    - 检查浏览器插件或企业策略是否强拦截新标签。
    - 观察 Nginx 是否正确应用了超时设置。

【关键代码位置】

- Nginx 长超时设置：`deploy/nginx/nginx.conf:41-56` 加 `proxy_read_timeout`、`proxy_send_timeout`、`proxy_buffering off`、`proxy_connect_timeout`.
- 后端心跳：`backend/internal/api/ws_handler.go:182-217`.
- 前端重连与心跳：`frontend/app/page.tsx:350-397` 的连接管理，`handleDownload` 与 `fetchDownloadLink` 相关逻辑在 `frontend/app/page.tsx:519-550`、`frontend/app/page.tsx:305-338`.


## 前端统一错误文案映射与接入25-12-11 05:25
- 目标：统一前端对常见 HTTP 状态（429/413/400/401/403）的用户友好提示，按操作语境（上传/生成 PDF/登录/默认）输出对应中文文案，消除重复硬编码。
- 映射函数：`frontend/hooks/useAuthFetch.ts:58-80` 导出 `friendlyMessageForStatus(status, kind)`，支持 `kind: "upload" | "pdf" | "login" | "default"`。
- 接入范围：
  - 登录页：`frontend/app/login/page.tsx:58` 非 2xx 时调用 `friendlyMessageForStatus(status, "login")`。
  - 注册页：`frontend/app/register/page.tsx:41` 非 201 时调用 `friendlyMessageForStatus(status)`。
  - 编辑器主页：
    - 生成任务提交：`frontend/app/page.tsx:539-547` 非 2xx 用 `friendlyMessageForStatus(status, "pdf")`。
    - 图片上传：`frontend/app/page.tsx:1265-1269` 非 2xx 用 `friendlyMessageForStatus(status, "upload")`；保留兜底错误。
  - 资产面板：`frontend/components/AssetsPanel.tsx:57` 列表失败用 `friendlyMessageForStatus(status)`。
  - 模板面板：列表/详情/创建/预览/删除统一接入 `friendlyMessageForStatus`（`frontend/components/TemplatesPanel.tsx:61-64, 92-95, 141-147, 169-171, 199-200`）。
  - 我的简历面板：列表/刷新/创建/读取/删除统一接入 `friendlyMessageForStatus`（`frontend/components/MyResumesPanel.tsx:63-66, 92-95, 128-134, 170-173, 209-214`）。
- 结果：
  - 当后端返回限流（429）、体积过大（413）、非法请求（400）、鉴权失败（401/403）时，前端可立即显示语境化中文提示，如“上传过于频繁”“文件过大，最大 5MB”“不支持的文件类型”“登录过于频繁或账号已锁定”等。
  - 减少多处重复的硬编码字符串，提升后续维护与一致性。


## 统一错误响应与鉴权失败响应25-12-02 09:35
- 核心需求：消除后端重复的鉴权失败响应与错误响应结构，统一失败体为 `{ "error": string }`，未授权统一为 `unauthorized`。
- 后端实现：
  - 新增 `backend/internal/api/response.go`，封装 `Error/AbortUnauthorized/Unauthorized/BadRequest/Forbidden/NotFound/Conflict/Internal`。
  - 重构 Handler：统一错误响应调用，覆盖 `resume_handler.go`（创建/读取/更新/删除/下载/下载链接/打印：`backend/internal/api/resume_handler.go:68-118, 121-146, 149-177, 179-206, 208-260, 261-295, 364-401, 430-462, 465-511`），`template_handler.go`（列表/详情/创建/删除/预览/打印：`backend/internal/api/template_handler.go:67-110, 112-151, 153-181, 183-221, 223-271, 273-320`），`asset_handler.go`（上传/列表/获取链接：`backend/internal/api/asset_handler.go:35-94, 96-141, 143-171`），`auth_handler.go`（注册/登录/刷新/退出：`backend/internal/api/auth_handler.go:41-88, 92-140, 144-235, 237-311`）。
  - 中间件：`backend/internal/api/middleware/auth_middleware.go:1-42` 统一未授权文案为小写，并移除对 `internal/api` 的直接依赖以避免循环导入（改为本文件内部 `abortUnauthorized`）。
- 文档维护：
  - 更新 `项目规划/ReadMe/backend_api.md`，加入统一错误响应约定与各接口失败体示例（如登录 `invalid credentials`、刷新/内部打印 `unauthorized`、简历上限 `resume limit reached`、下载链接 `pdf not ready`、资产鉴权 `access denied` 等）。
- 构建与测试：
  - `cd backend && go build ./cmd/...` 通过（本地验证）。
  - `go test ./...` 中 `internal/config` 的用例因未设置 JWT 私钥等环境变量而失败，属于环境前置条件缺失；与本次改造无关。
- 影响评估：
  - 响应体结构与状态码保持不变；统一未授权文案为 `unauthorized`，前端未依赖具体文案，行为兼容。

## Lexical 顶部工具栏与 Markdown 支持25-11-20 05:30
- **核心需求**：多实例文本模块共享单一顶部胶囊工具栏，统一完成标题/列表/粗斜体/对齐，并支持 Markdown 快捷输入。
- **实现**：
  - 新增 `ActiveEditorContext` 记录当前聚焦的 LexicalEditor，并在 `app/page.tsx` 顶层包裹 Provider + 渲染 `TopToolbar`。
  - 新建 `TopToolbar`（HeroUI + Lucide）：Undo/Redo、段落/Heading1-3、粗斜体/下划线、无序/有序列表、左右中对齐；点击时保持编辑器焦点。
  - `TextItem` 接入 `FocusTrackerPlugin`、`MarkdownShortcutPlugin`、`ListPlugin`，注册 Heading/List/Quote/Code/Link 节点；聚焦态显示蓝色 ring，内容区使用统一 typography 样式。
  - 全局样式补充 `.text-item-editor/.text-item-readonly` 排版；`package.json` 增加 `@lexical/list`/`markdown`/`rich-text`/`utils`/`code`/`link`、`lucide-react`。


# 变更记录（2025-11-20）

- 保留核心：未改动编辑器画布与 `ReactGridLayout` 内部逻辑、打印视图 `/print/[id]` 与 `#pdf-render-ready`、Lexical 基本装配。

- 样式面板增强：
  - 将粗体/斜体/下划线格式控制移至左侧样式面板，避免占用模块内部空间。
  - 新增三个开关并即时作用于选中文本模块的样式：
    - 粗体：`fontWeight` 切换（`frontend/app/page.tsx:896-913`）。
    - 斜体：`fontStyle` 切换（`frontend/app/page.tsx:914-931`）。
    - 下划线：`textDecoration` 切换（`frontend/app/page.tsx:932-956`）。
  - 面板控件位置：`frontend/components/StylePanel.tsx:57-125`。
  - 移除文本模块内工具栏，保留 Lexical 编辑器主体：`frontend/components/TextItem.tsx:152-174`。

- 我的简历列表优化：
  - 响应式网格：`sm:1`、`md:2`、`lg:3` 列，≥3 项自动采用多列（`frontend/components/MyResumesPanel.tsx:260-329`）。
  - 客户端分页：每页 6，新增页码与翻页按钮，刷新列表时重置到第 1 页（`frontend/components/MyResumesPanel.tsx:38-47,83-95,260-329`）。

- 模块操作按钮外框化：
  - RGL 单元容器加 `group`，拖动/删除图标融入边框角并在 `group-hover` 显示（`frontend/app/page.tsx:988-1019`）。
  - 拖动句柄保留 `.rgl-drag-handle`，删除按钮加 `aria-label`。

- 分割线颜色绑定修复：
  - 颜色选择器对分割线统一更新 `style.borderColor`，若存在 `borderTop: '2px solid #xxxxxx'` 则替换其中颜色段（`frontend/app/page.tsx:528-547`）。
  - 文本模块仍使用 `style.color`；打印视图按 `item.style` 渲染，保证一致。

- PDF 打开策略调整：
  - 仅在 WebSocket 收到 `{status: 'completed', resume_id}` 后才调用 `fetchDownloadLink(resume_id)` 并在新标签页打开（保留 `app/page.tsx:199-206` 的完成回调）。
  - 移除提交后主动轮询下载链接的逻辑，避免打开旧 PDF（`frontend/app/page.tsx:349-375` 去除回退轮询）。

- 构建与验证：
  - `npm run build` 通过；打印路由未注入 Provider/动效；StylePanel 的 onChange 仍“立即更新” `layout_settings`。


## 模板预览手动生成25-11-19 21:18
- **核心需求**：模板无需在保存时立即生成缩略图，由用户手动触发“生成预览”以截取当前渲染结果，便于随时刷新模版缩略图。
- **后端实现**：
  - `TemplateHandler` 注入 Asynq Client、Storage 与 `INTERNAL_API_SECRET`，新增 `POST /v1/templates/:id/generate-preview` 入队 `template:generate_preview` 任务，`GET /v1/templates/print/:id` 输出 go-rod 渲染所需 JSON。
  - 新建 `TemplatePreviewHandler`，调用复用后的 Rod 渲染辅助函数打开 `/print-template/:id`，截取 `#a4-container`，上传 `thumbnails/template/{id}/preview.jpg` 并生成 7 天预签名 URL 写回库。
  - 抽取打印数据的图片内联逻辑，复用到简历与模板打印接口。
- **前端实现**：
  - 抽出通用 `PrintView` 组件，并新增 `/print-template/[id]` 页面供 worker 访问。
  - TemplatesPanel 缺省显示相机占位图，模板卡片增加“刷新预览”按钮，调用新 API，并在生成期间显示 loading/遮罩，完成后自动刷新列表。


## PDF 生成后自动产出缩略图25-11-19 19:20
- **核心需求**：PDF 生成成功后立即复用 worker 中已打开的 go-rod 页面，截取 A4 画布缩略图，上传到 MinIO，并将预签名 URL 写回 `resumes.preview_image_url`，以便“我的简历”列表展示缩略图。
- **后端实现**：
  - 将 `generatePDFFromFrontend` 改为返回 `page` 与 `cleanup`，让 `ProcessTask` 在上传 PDF 后继续使用该页面截屏，最后统一关闭 rod 资源。
  - 新增 `generatePreviewImage`/`capturePreviewScreenshot`：优先截取 `#a4-container` 的 JPEG，否则退化到整页截图，按 `/resume/{id}/preview_{timestamp}.jpg` 上传，并生成 7 天预签名链接；所有失败只打警告日志，不影响主流程。
  - 截图、上传、回写均沿用现有 `storage.Client`/GORM，确保缩略图生成独立且易于回放（老简历重新生成 PDF 即可补充）。

## 多份简历与模板限额支持25-11-19 17:30
- **核心需求**：普通用户可保存多份私有简历（默认 3 份）、模板最多 2 份，并能在编辑器内管理、加载、删除。
- **后端实现**：
  - `config.API` 新增 `max_resumes`、`max_templates`，通过环境变量配置，`routes` 注册时下发给 Handler。
  - `users` 表增加 `active_resume_id`、`resumes` 表增加 `preview_image_url`，用于记录当前编辑项及缩略图占位。
  - `ResumeHandler` 提供列表/创建/读取/更新/删除接口，写入时做数量校验，并在加载/删除时自动维护 `active_resume_id` 以兼容 `GET /v1/resume/latest`。
  - `TemplateHandler` 创建前统计用户私有模板数，超过上限返回 403，提示升级。
- **前端实现**：
  - 抽取 `frontend/utils/resume.ts` 统一维护默认布局与 `normalizeResumeContent`，供编辑器与抽屉面板复用。
  - `MyResumesPanel` 参考模板面板样式，实现“另存为新简历 + 列表 + 加载 + 删除”工作流，并与主编辑器状态联动。
  - 编辑器的“保存简历”按钮：若已有 `savedResumeId` 调用 `PUT /v1/resume/:id` 覆盖，若无则弹出标题后 `POST /v1/resume` 另存；另增加“我的简历”按钮进入面板。
