# 变更记录

## 多份简历与模板限额支持25-11-19 17:30
- **核心需求**：普通用户可保存多份私有简历（默认 3 份）、模板最多 2 份，并能在编辑器内管理、加载、删除。
- **后端实现**：
  - `config.API` 新增 `max_resumes`、`max_templates`，通过环境变量配置，`routes` 注册时下发给 Handler。
  - `users` 表增加 `active_resume_id`、`resumes` 表增加 `preview_image_url`，用于记录当前编辑项及缩略图占位。
  - `ResumeHandler` 提供列表/创建/读取/更新/删除接口，写入时做数量校验，并在加载/删除时自动维护 `active_resume_id` 以兼容 `GET /v1/resume/latest`。
  - `TemplateHandler` 创建前统计用户私有模板数，超过上限返回 403，提示升级。
- **前端实现**：
  - 抽取 `frontend/utils/resume.ts` 统一维护默认布局与 `normalizeResumeContent`，供编辑器与抽屉面板复用。
  - `MyResumesPanel` 参考模板面板样式，实现“另存为新简历 + 列表 + 加载 + 删除”工作流，并与主编辑器状态联动。
  - 编辑器的“保存简历”按钮：若已有 `savedResumeId` 调用 `PUT /v1/resume/:id` 覆盖，若无则弹出标题后 `POST /v1/resume` 另存；另增加“我的简历”按钮进入面板。

## PDF 生成后自动产出缩略图25-11-19 19:20
- **核心需求**：PDF 生成成功后立即复用 worker 中已打开的 go-rod 页面，截取 A4 画布缩略图，上传到 MinIO，并将预签名 URL 写回 `resumes.preview_image_url`，以便“我的简历”列表展示缩略图。
- **后端实现**：
  - 将 `generatePDFFromFrontend` 改为返回 `page` 与 `cleanup`，让 `ProcessTask` 在上传 PDF 后继续使用该页面截屏，最后统一关闭 rod 资源。
  - 新增 `generatePreviewImage`/`capturePreviewScreenshot`：优先截取 `#a4-container` 的 JPEG，否则退化到整页截图，按 `/resume/{id}/preview_{timestamp}.jpg` 上传，并生成 7 天预签名链接；所有失败只打警告日志，不影响主流程。
  - 截图、上传、回写均沿用现有 `storage.Client`/GORM，确保缩略图生成独立且易于回放（老简历重新生成 PDF 即可补充）。

## 模板预览手动生成25-11-19 21:18
- **核心需求**：模板无需在保存时立即生成缩略图，由用户手动触发“生成预览”以截取当前渲染结果，便于随时刷新模版缩略图。
- **后端实现**：
  - `TemplateHandler` 注入 Asynq Client、Storage 与 `INTERNAL_API_SECRET`，新增 `POST /v1/templates/:id/generate-preview` 入队 `template:generate_preview` 任务，`GET /v1/templates/print/:id` 输出 go-rod 渲染所需 JSON。
  - 新建 `TemplatePreviewHandler`，调用复用后的 Rod 渲染辅助函数打开 `/print-template/:id`，截取 `#a4-container`，上传 `thumbnails/template/{id}/preview.jpg` 并生成 7 天预签名 URL 写回库。
  - 抽取打印数据的图片内联逻辑，复用到简历与模板打印接口。
- **前端实现**：
  - 抽出通用 `PrintView` 组件，并新增 `/print-template/[id]` 页面供 worker 访问。
  - TemplatesPanel 缺省显示相机占位图，模板卡片增加“刷新预览”按钮，调用新 API，并在生成期间显示 loading/遮罩，完成后自动刷新列表。
