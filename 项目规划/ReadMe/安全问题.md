# 部署前安全问题清单（生产环境）

> 场景前提：部署到 Ubuntu 22.04 + Docker（单机），并且 **DB/MinIO/Grafana/Prometheus 等端口会对公网开放**，但你会通过云平台安全组/防火墙仅放行你自己的 IP 访问这些管理端口。  
> 说明：即便只放行个人 IP，这些端口依然属于“公网可达面”，一旦 IP 放行配置出错、你的设备/密钥泄露、或出现 SSRF/反代绕过，风险会被放大。因此仍按生产安全基线对待。

## 风险分级

- **P0（上线前必须解决）**：存在明显“被扫就爆”的风险，或等同后门/越权/敏感数据泄露。
- **P1（强烈建议上线前完成）**：不一定立刻被利用，但一旦出事影响面大，或容易被链式利用。
- **P2（中长期改进）**：提升整体安全韧性与可维护性。

## P0（上线前必须解决）

### 1) 内置默认用户/口令（等同后门）[已解决]

- **现状**：API 启动时会自动创建默认用户 `test_user/seeded-password`。
- **风险**：生产环境出现可预测账号密码；任何人拿到访问入口都可直接登录。
- **建议**：
  - 生产环境必须移除自动 seed；改为显式初始化命令（一次性）或只在 `ENV=dev` 时允许。
  - 如确实需要初始化管理员：使用随机强密码/一次性 token，并强制首次登录改密。
- **定位点**：`backend/cmd/api/main.go:65`

### 2) 默认/弱凭据（数据库、对象存储、监控面板、内部密钥）[已部分解决]

- **现状**：
  - Postgres 默认 `phresume/phresume`。
  - MinIO 默认 `minioadmin/minioadmin`，且镜像使用 `latest`。
  - Grafana 默认 `admin/admin`。
  - `INTERNAL_API_SECRET` 示例值 `your-random-string`。
- **风险**：安全组规则一旦放宽或误配，会被自动化扫描迅速攻破；同时也增加内部人员误操作风险。
- **建议**：
  - 所有口令/密钥改为高强度随机值，并通过环境变量/密钥管理注入（严禁入库）。
  - 重要凭据支持轮换（尤其是 `INTERNAL_API_SECRET`、DB、对象存储访问密钥）。
  - 镜像版本 pin 具体 tag，避免 `latest` 漂移。
- **当前进展**：
  - `docker-compose.yml` 已改为从根目录 `.env` 读取 `DB_PASSWORD`、`MINIO_ROOT_PASSWORD`、`GRAFANA_PASSWORD`、`INTERNAL_API_SECRET` 等。
  - 监控相关镜像已固定版本：Loki `grafana/loki:3.0.0`、Promtail `grafana/promtail:3.0.0`、Prometheus `prom/prometheus:v2.53.0`、Grafana `grafana/grafana:11.1.0`。
  - MinIO 仍使用 `latest`（后续计划迁移到腾讯云对象存储）。
- **定位点**：
  - `docker-compose.yml:17`、`docker-compose.yml:60`、`docker-compose.yml:232`、`docker-compose.yml:104`
  - `backend/.env.example:1`

### 3) 内部打印接口（打印数据）存在“被外网直接打到”的风险 [已部分解决]

- **现状**：
  - 内部接口：`/v1/resume/print/:id`、`/v1/templates/print/:id`，仅依赖请求头 `X-Internal-Secret`。
  - Nginx `/api/` 反代会把请求转给 API，并不会阻断这些路径。
- **风险**：
  - 一旦 `INTERNAL_API_SECRET` 泄露（日志/误配置/代码泄露/运维误传），即可绕过用户鉴权拉取打印数据（含预签名图片 URL 等）。
  - 由于你计划对公网开放更多端口，整体攻击面更大，任何一个点泄露密钥都会“横向放大”。
- **建议（至少二选一，最好叠加）**：
  - **Nginx 层阻断**：对 `/api/v1/resume/print/` 与 `/api/v1/templates/print/` 做 `deny all`，只允许 worker 内网访问（容器网络/内网 IP 段）。
  - **API 层加强**：除 `X-Internal-Secret` 外，再加来源约束（只允许来自 worker 网络/固定 IP）、或将内部接口监听在独立内网端口（不对外暴露）。
  - **密钥管理**：`INTERNAL_API_SECRET` 必须是随机高熵值，并支持快速轮换。
- **当前进展**：
  - 已在面向公网的 Nginx 配置中对 `/api/v1/(resume|templates)/print/*` 直接返回 `404`，阻止外部访问。
  - 重要提醒：该措施只覆盖“经由 Nginx 访问 API”的流量；如果你在生产环境将 API 容器端口（例如 `8080`）直接映射到公网，外部仍可绕过 Nginx 直接访问这些内部接口（此时需要通过不暴露 API 端口/绑定到 `127.0.0.1`/云安全组与主机防火墙等方式额外控制）。
- **定位点**：
  - `backend/internal/api/routes.go:76`
  - `backend/internal/api/middleware/internal_secret.go:10`
  - `deploy/nginx/nginx.conf:43`

### 4) 对外暴露面过大（端口直接映射到宿主机）[已部分解决----后续需要注意]

- **现状**：当前 compose 映射了 Postgres、MinIO、Loki、Prometheus、Grafana 等端口到宿主机（`ports:`）。
- **风险**：即便你计划用安全组只放行个人 IP，也存在误配/变更漂移/临时放行遗忘的风险；被扫到就会进入密码爆破、漏洞利用、面板弱口令等路径。
- **建议**：
  - 明确哪些端口“必须公网访问”，其余只在内网暴露（不映射 `ports`，或绑定到 `127.0.0.1` 并通过 SSH 隧道访问）。
  - 云安全组规则必须最小化：仅放行你的固定出口 IP（如有变动，更新流程要可追踪）。
  - Grafana/Prometheus/MinIO 控制台应加额外认证与审计（如强口令、2FA、访问日志）。
- **当前进展**：
  - 已移除 `loki` 的 `3100:3100` 与 `prometheus` 的 `9091:9090` 对外端口映射，仅允许容器网络内访问（Grafana 仍通过 `http://loki:3100`、`http://prometheus:9090` 读取数据源）。
- **定位点**：`docker-compose.yml`（多处 `ports:`）

### 5) 缺少 HTTPS（Cookie 与传输安全）[跳过]

- **现状**：Nginx 目前只有 80 端口；刷新令牌使用 Cookie 且 `Secure` 依赖 `X-Forwarded-Proto=https` 判断。
- **风险**：无 HTTPS 会导致 Cookie 不能可靠设置为 `Secure`，且存在明文传输风险（中间人/劫持）。
- **建议**：
  - 上线必须启用 HTTPS（Let’s Encrypt 或云 CDN/负载均衡终止 TLS）。
  - 确保反代正确设置 `X-Forwarded-Proto`，并评估 Cookie `SameSite` 策略是否满足前后端跨域需求（目前为 Lax）。
- **定位点**：
  - `deploy/nginx/nginx.conf:28`
  - `backend/internal/api/auth_handler.go:281`
  - `backend/internal/api/auth_handler.go:345`

### 6) 预签名 URL 的公网端点必须正确且可控 [跳过]

- **现状**：对象存储对外访问端点由 `MINIO_PUBLIC_ENDPOINT` 决定；当前示例是 `http://localhost:9000`。
- **风险**：
  - 生产若配置成内网地址，会导致浏览器无法访问（功能故障），也可能泄露内网拓扑。
  - 若对外端点未做域名/证书/权限控制，可能引入额外风险（尤其你未来考虑迁移到腾讯云 COS）。
- **建议**：
  - 生产将 `MINIO_PUBLIC_ENDPOINT` 设置为真实公网域名（建议 HTTPS）。
  - 若未来迁移到腾讯云 COS：优先走 S3 兼容或官方 SDK，并评估签名/地域/时钟偏差等差异；迁移期间避免双写密钥暴露。
- **定位点**：
  - `backend/internal/storage/minio.go:21`
  - `backend/internal/config/config.go:192`
  - `docker-compose.yml:99`

## P1（强烈建议上线前完成）[暂时跳过]

### 1) docker.sock 挂载（容器逃逸/主机控制权风险）

- **现状**：Promtail、Prometheus 挂载了宿主机 `/var/run/docker.sock`。
- **风险**：任一相关容器被拿下，可能通过 Docker API 进一步控制整台主机（非常高价值目标）。
- **建议**：
  - 生产最小化部署：不需要可观测性时先不上；需要时确保网络隔离、严格访问控制与镜像更新策略。
  - 评估更安全的日志/指标采集方式（避免直接暴露 docker.sock 或通过代理层做权限隔离）。
- **定位点**：`docker-compose.yml:197`、`docker-compose.yml:213`；`deploy/promtail/promtail-config.yml:13`

### 2) 生产镜像/运行模式仍为开发模式 

- **现状**：API/Worker 用 `air` + 源码挂载；前端用 `next dev`。
- **风险**：镜像不可变性差、依赖不受控、攻击面更大（开发工具链、热重载、源码可读等）。
- **建议**：
  - 生产使用独立 `Dockerfile`/多阶段构建，输出最小化运行镜像；关闭热重载、移除源码挂载。
  - 使用非 root 用户、只读文件系统、限制 capability（按需）。
- **定位点**：`docker-compose.yml:111`、`docker-compose.yml:128`、`docker-compose.yml:169`；`backend/Dockerfile.api:53`；`frontend/Dockerfile:9`

### 3) 密钥与环境变量治理

- **现状**：已将关键密钥与 Worker 运行参数统一收敛到 `backend/internal/config`，并在缺失时直接启动失败（避免运行中才暴露漏配）。
- **风险**：漏配/误配导致安全策略失效；密钥轮换困难；排障时容易把密钥打进日志或错误分享。
- **建议**：
  - 统一在配置层收敛关键参数，并为“生产缺失/弱值”提供启动失败/强提示。
  - 通过 GitHub Actions Secrets / 云 KMS / 参数存储注入，禁止明文入库。
- **已收敛的关键项（示例）**：
  - `INTERNAL_API_SECRET`（API/Worker 共用内部调用密钥）
  - `WORKER_INTERNAL_API_BASE_URL`、`WORKER_FRONTEND_BASE_URL`、`WORKER_METRICS_ADDR`、`WORKER_CONCURRENCY`（Worker 运行参数）
  - 兼容别名：`DB_NAME/DB_USER/DB_PASSWORD`、`MINIO_ROOT_USER/MINIO_ROOT_PASSWORD`
- **定位点**：`backend/internal/config/config.go`

### 4) 管理端口公网开放的额外防护（在安全组之外）

- **现状**：你计划用安全组仅放行个人 IP。
- **风险**：个人 IP 可能变化/被劫持；规则可能被临时放开；对外服务仍会遭遇漏洞利用扫描。
- **建议**：
  - 为 Grafana/MinIO 控制台启用 2FA/强口令/最小权限账号，避免默认管理员长期使用。
  - 对管理面板增加第二道门槛：VPN/堡垒机/SSH 隧道（即便安全组已限制）。
  - 启用审计与告警（登录失败、异常来源 IP、暴力破解等）。

## P2（中长期改进）[暂时跳过]

### 1) JWT 声明与跨环境误用防护

- **现状**：主要校验算法 + 过期时间；未看到 `iss/aud` 等强约束。
- **收益**：降低 token 在不同环境/不同服务间误用的风险。
- **定位点**：`backend/internal/auth/auth_service.go:121`

### 2) 上传与内容安全增强

- **现状**：已有 ClamAV 扫描、大小限制、MIME sniff + 白名单。
- **建议**：增加图像解码校验、像素/尺寸上限、超时与资源限制策略；完善上传审计日志。
- **定位点**：`backend/internal/api/asset_handler.go:44`

### 3) 备份/恢复/灾难演练与凭据轮换流程

- **建议**：明确 DB/对象存储备份策略、恢复演练、密钥轮换与回滚流程，避免“只能重建不能恢复”。

---

## 下一步建议（按顺序）

1. 先消除 P0：移除默认用户、替换全部默认凭据、上线 HTTPS、收敛对外暴露端口策略、加固内部打印接口访问面。
2. 再处理 P1：尤其是 docker.sock 的隔离与生产镜像化。
3. 最后做 P2：token 声明、上传增强、备份演练与轮换机制。
