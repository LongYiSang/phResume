# 可观测性与日志链路说明

本说明面向在本地 `docker-compose` 环境下调试 phResume 的开发者，帮助快速定位日志、指标和管理页面。

## 1. 日志链路

1. **应用产生日志**：`backend/cmd/api` 与 `backend/cmd/worker` 中通过 `log/slog` 输出结构化文本，Gin 中间件 `CorrelationIDMiddleware` + `SlogLoggerMiddleware` 会为每个请求生成/透传 `X-Correlation-ID` 并写入日志；任务队列 payload（`internal/tasks/payloads.go`）同样携带 `correlation_id`，确保 API 与 Worker 日志可关联。
2. **采集**：`deploy/promtail/promtail-config.yml` 配置 Promtail 通过 docker_sd 监听 `phresume_app-network` 上的容器 stdout，自动打上 `service=<compose service>` 标签，并尝试解析日志中的 `correlation_id`。
3. **存储**：Promtail 把日志推送到 Loki（`deploy/loki/loki-config.yml`），容器端口 3100 暴露到主机 `http://localhost:3100`。
4. **展示**：Grafana 中的日志面板（`deploy/grafana/provisioning/dashboards/main_dashboard.json`）默认查询 `{service="$service"}`，可使用仪表盘变量按服务或 `correlation_id` 过滤。

> ⚠️ 当前 Logger 采用文本 handler，若需更准确的 `json` 解析，可后续切换到 `slog.NewJSONHandler`。

## 2. 指标链路

1. **API 与 Worker 暴露 `/metrics`**：
   - API 通过 `internal/metrics/gin.go` 中的 Gin 中间件收集请求耗时/状态，并在 `backend/cmd/api/main.go` 中加入 `router.GET("/metrics", promhttp.Handler())`。
   - Worker 在 `backend/cmd/worker/main.go` 启动独立的 `:9100/metrics` HTTP server，并在 `internal/metrics/asynq.go` 记录任务指标。
2. **采集**：Prometheus `deploy/prometheus/prometheus.yml` 使用 Docker SD 发现 `api`/`worker` 容器，分别抓取 `api:8080/metrics` 与 `worker:9100/metrics`。
3. **展示**：Grafana 数据源 `Prometheus`（UID `prometheus`）已在 `deploy/grafana/provisioning/datasources/datasources.yml` 预配置；仪表盘提供请求耗时、Asynq 任务等面板。

## 3. 可访问节点（默认 docker-compose 网络映射）

| 服务 | 描述 | 地址/端口 | 默认凭证 |
| --- | --- | --- | --- |
| Web 前端 | Nginx 反代到 Next.js (`frontend`) | http://localhost | 无 |
| API (Gin) | 通过 Nginx `/api` 转发；也可直连容器 `api:8080` | http://localhost/api | 按 JWT/登录流程 |
| Grafana | 可观测性仪表盘 | http://localhost:3000 | admin / admin |
| Prometheus | 指标查询 UI | http://localhost:9091 | 无认证 |
| Loki API | 日志查询 API（可配合 `logcli`） | http://localhost:3100 | 无认证 |
| Promtail | 仅内部采集，无 UI | 容器 `promtail` | - |
| PostgreSQL | 数据库 | localhost:5432 | phresume / phresume |
| Redis | 缓存与 Asynq 队列 | localhost:6379 | 无密码 |
| MinIO 控制台 | 对象存储管理界面 | http://localhost:9001 | minioadmin / minioadmin |
| MinIO S3 API | 供应用访问的 S3 兼容端点 | http://localhost:9000 | 同上 |

> 访问容器内服务可使用 `docker compose exec <service> ...`。

## 4. 常用排障步骤

- **查看日志**：在 Grafana Logs 面板选择 `service=api/worker` 并输入 `correlation_id="<ID>"`；或使用 `docker compose logs <service>`。
- **指标不更新**：确认 `api`、`worker` 容器仍暴露 `/metrics`，并检查 `prometheus` 服务 `docker compose logs prometheus` 是否有采集错误。
- **Grafana 登陆失败**：删除 `grafana_data` 卷后重新 `docker compose up`（将重置账号为 admin/admin）。
- **MinIO 访问失败**：确保 `minio` 容器健康（`docker compose ps`），并检查 `.env` / `docker-compose.yml` 中 `MINIO_*` 配置。

## 5. 参考文件

- `docker-compose.yml`：所有服务端口映射、依赖与环境变量。
- `deploy/promtail/promtail-config.yml`：日志采集配置。
- `deploy/loki/loki-config.yml`：Loki 存储配置。
- `deploy/prometheus/prometheus.yml`：指标抓取目标。
- `deploy/grafana/provisioning/*`：Grafana 数据源与仪表盘。
- `backend/internal/metrics/*`、`backend/internal/api/middleware/*`：应用内日志/指标中间件。

